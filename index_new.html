<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="index.css">
    <title>TV</title>
</head>
<body style="overflow:  hidden;">
<div id="container">

    <div id="lectures" class="lectures">
        <div class="block">
            <img src="vizual1.png" class="visual--img">
        </div>

        <div class="lectures-container">
            <h1 id="schedule" class="classroom-text-container--medium">Predavanja danas:</h1>
            <div class ="container">
                <div class="timings">
                    <div> <span> 7:00 </span></div>
                    <div> 7:30 </div>
                    <div> <span> 8:00 </span></div>
                    <div> 8:30 </div>
                    <div> <span> 9:00 </span></div>
                    <div> 9:30 </div>
                    <div> <span> 10:00 </span></div>
                    <div> 10:30 </div>
                    <div> <span> 11:00 </span></div>
                    <div> 11:30 </div>
                    <div> <span> 12:00 </span></div>
                    <div> 12:30 </div>
                    <div> <span> 13:00 </span></div>
                    <div> 13:30 </div>
                    <div> <span> 14:00 </span></div>
                    <div> 14:30 </div>
                    <div> <span> 15:00 </span> </div>
                    <div> 15:30 </div>
                    <div> <span> 16:00 </span> </div>
                    <div> 16:30 </div>
                    <div> <span> 17:00 </span> </div>
                    <div> 17:30 </div>
                    <div> <span> 18:00 </span> </div>
                    <div> 18:30 </div>
                    <div> <span> 19:00 </span> </div>
                    <div> 19:30 </div>
                    <div> <span> 20:00 </span> </div>
                    <div> 20:30 </div>
                    <div> <span> 21:00 </span> </div>
                </div>
                <svg version="1.1" width="1000" height="800">
                    <line x1="10" y1="10" x2="700" y2="10" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="66" x2="700" y2="66" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="122" x2="700" y2="122" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="178" x2="700" y2="178" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="234" x2="700" y2="234" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="290" x2="700" y2="290" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="346" x2="700" y2="346" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="402" x2="700" y2="402" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="458" x2="700" y2="458" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="514" x2="700" y2="514" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="570" x2="700" y2="570" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="626" x2="700" y2="626" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="682" x2="700" y2="682" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="738" x2="700" y2="738" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="794" x2="700" y2="794" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="850" x2="700" y2="850" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="906" x2="700" y2="906" stroke="#dddddd" stroke-width="2"></line>
                    <line x1="10" y1="962" x2="700" y2="962" stroke="#dddddd" stroke-width="2"></line>
                </svg>
                <div class="days" id="events">
                </div>
            </div>

        </div>
    </div>

    <div id=logo_animation_1 style="display:none;height: 100%;position: relative;">
        <img id="vizual_1" src="vizual2.png" class="logo-1">
    </div>

    <div id=logo_animation_2 style="display:none;">
        <img id="vizual_2" src="vizual3.png" class="logo-2">
    </div>

    <div id=logo_animation_3 style="display:none;">
        <img id="vizual_3" src="vizual4.png" class="logo-3">
    </div>

</div>
</body>

<script src="script.js"></script>

<script>

    let token, i;
    let lectures = [];

    function log(status, text){
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://127.0.0.1:5000/", false);

                xhr.setRequestHeader('Content-Type', 'text/plain');

                xhr.send(JSON.stringify({
                    status: status,
                    msg: text
                }));


        console.log(xhr.responseText)
        console.log("ok")
    }

    function getToken() {
        let url = "http://127.0.0.1:5000/";
        let xhr = new XMLHttpRequest();
        xhr.open("GET", url, false);
        xhr.send(null);
        token  =  JSON.parse(xhr.responseText).token;
        log("OK",   "token: " + token);
        console.log(token)
    }

    function getLectures(token, classRoomId, classRoomName){
        log("OK",     "display lectures");
        let i;
        let URL = "https://graph.microsoft.com/v1.0/sites/edf88b6f-e898-4bcc-819f-d1c8cdad28d7/lists/" + classRoomId + "/items";
        let xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", URL, false ); // false for synchronous request
        let tokenStr = 'Bearer ';
        tokenStr = tokenStr.concat(token);
        xmlHttp.setRequestHeader('Authorization', tokenStr);
        xmlHttp.send(null);
        log("OK", "token: " + tokenStr);
        if (xmlHttp.status != 200){
            log("ERROR", xmlHttp.status);
            log("ERROR", xmlHttp.responseText);
            return false
        }

        let responseItemsJSON = JSON.parse(xmlHttp.responseText);
        for(i = 0; i<responseItemsJSON.value.length; i++) {

            let lectureId = responseItemsJSON.value[i].id;
            let request = "https://graph.microsoft.com/v1.0/sites/edf88b6f-e898-4bcc-819f-d1c8cdad28d7/lists/" + classRoomId + "/items/";

            request = request.concat(lectureId);

            xmlHttp.open( "GET", request, false );
            xmlHttp.setRequestHeader('Authorization', tokenStr);
            xmlHttp.send( null );
            if (xmlHttp.status != 200){
                log("ERROR", xmlHttp.status);
                log("ERROR", xmlHttp.responseText);
                return false
            }
            let responseLectureJSON = JSON.parse(xmlHttp.responseText);
            let classRoom = responseLectureJSON.fields.Category;
            let className = responseLectureJSON.fields.Title;
            let classStartDateStr = responseLectureJSON.fields.EventDate;
            let classEndDateStr = responseLectureJSON.fields.EndDate;
            let classStartDate = new Date(classStartDateStr);
            let classEndDate = new Date(classEndDateStr);

            let classStartHours = classStartDate.getHours();
            let classStartMinutes = classStartDate.getMinutes();
            if (classStartHours.toString().length < 2) {
                classStartHours = "0" + classStartHours.toString()
            }
            if (classStartMinutes.toString().length < 2) {
                classStartMinutes = "0" + classStartMinutes.toString()
            }
            let classStartTime = classStartHours + ":" + classStartMinutes;

            let classEndHours = classEndDate.getHours();
            let classEndMinutes = classEndDate.getMinutes();
            if (classEndHours.toString().length < 2) {
                classEndHours = "0" + classEndHours.toString()
            }
            if (classEndMinutes.toString().length < 2) {
                classEndMinutes = "0" + classEndMinutes.toString()
            }
            let classEndTime = classEndHours + ":" + classEndMinutes;
            let todayDate = new Date();

            let startDateZero = new Date(classStartDateStr);
            let endDateZero = new Date(classEndDateStr);
            let todayDateZero = new Date();
            startDateZero.setHours(0,0,0,0);
            endDateZero.setHours(0,0,0,0);
            todayDateZero.setHours(0,0,0,0);

            let recurrence = responseLectureJSON.fields.fRecurrence;
            //if event is recurring lecture, check if today's day of the week is same as the lecture and if lectures has started but not ended
            if (recurrence){
                if (startDateZero.getDay() === todayDateZero.getDay() && startDateZero <= todayDateZero && endDateZero >= todayDateZero){
                    let lecture = new Object();
                    lecture.name = className;
                    lecture.start = classStartDate.getHours()*60 + classStartDate.getMinutes();
                    lecture.end = classEndDate.getHours()*60 + classEndDate.getMinutes();
                    lecture.time = classStartTime + " - " + classEndTime;
                    lecture.classRoom = classRoomName;
                    lectures.push(lecture);

                }
            //if event is one time lecture, check if it starts at today's date
            } else {
                if (classStartDate.getDate() === todayDate.getDate() && classStartDate.getMonth() === todayDate.getMonth() && classStartDate.getFullYear() === todayDate.getFullYear()){

                    let lecture = new Object();
                    lecture.name = className;
                    lecture.start = classStartDate.getHours()*60 + classStartDate.getMinutes();
                    lecture.end = classEndDate.getHours()*60 + classEndDate.getMinutes();
                    lecture.time = classStartTime + " - " + classEndTime;
                    lecture.classRoom = classRoomName;
                    lectures.push(lecture);

                }
            }

        }

        return true
    }

    function compare( a, b ) {
        if ( a.start > b.start ){
            return -1;
        }
        if ( a.start < b.start ){
            return 1;
        }
        return 0;
    }

    function loop() {
        let classRoomIdRacunalna = "b20f285c-260f-4929-a0d8-b002c19a6742";
        let classRoomIdPraktikum = "2dbb5a38-8f4d-44c5-8824-8334a1e11bf4";

        if (! (getLectures(token, classRoomIdRacunalna, "Računalna") && (getLectures(token, classRoomIdPraktikum, "Praktikum")))){
            getToken();
            getLectures(token,  classRoomIdRacunalna, "Računalna");
            getLectures(token,  classRoomIdPraktikum, "Praktikum");

        }
        lectures.sort(compare);
        layOutDay(lectures);
        i++;

        if (i%2 === 1){
            document.getElementById("lectures").style.display = 'block';
            document.getElementById("logo_animation_1").style.display = 'none';
            document.getElementById("logo_animation_2").style.display = 'none';
            document.getElementById("logo_animation_3").style.display = 'none';
            setTimeout(loop, 5000);

        } else {
            if ((i/2)%3===2){
                  document.getElementById("lectures").style.display = 'none';
                  document.getElementById("logo_animation_1").style.display = 'block';
                  document.getElementById("logo_animation_2").style.display = 'none';
                  document.getElementById("logo_animation_3").style.display = 'none';
                  setTimeout(loop, 5000);
            } else if ((i/2)%3===1) {
                  document.getElementById("lectures").style.display = 'none';
                  document.getElementById("logo_animation_1").style.display = 'none';
                  document.getElementById("logo_animation_2").style.display = 'block';
                  document.getElementById("logo_animation_3").style.display = 'none';
                  setTimeout(loop, 5000);
            } else {
                  document.getElementById("lectures").style.display = 'none';
                  document.getElementById("logo_animation_1").style.display = 'none';
                  document.getElementById("logo_animation_2").style.display = 'none';
                  document.getElementById("logo_animation_3").style.display = 'block';
                  setTimeout(loop, 5000);
            }
      }


    }
    i = 0;
    getToken();
    loop();





</script>

</html>
